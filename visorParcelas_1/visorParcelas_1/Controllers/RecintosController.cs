using Microsoft.AspNetCore.Mvc;
using Newtonsoft.Json;
using Npgsql;
using System.Security.Principal;
using visorParcelas_1.Geometry;

namespace visorParcelas_1.Controllers
{
    [ApiController]
    [Route("[controller]")]
    public class RecintosController : ControllerBase
    {
        private readonly ILogger<RecintosController> _logger;


        public RecintosController(ILogger<RecintosController> logger)
        {
            _logger = logger;
        }

        private void TestMethod()
        {
            Console.WriteLine("This is a test");
        }

        //Código que hace que aparezca el controlador en pantalla
        [HttpGet]
        public async Task<ActionResult<geoJson>> Get(int provincia = 28, int municipio = 85, int agregado = 0, int zona = 0, int poligono = 1, int parcela = 1, int recinto = 8)
        {

            //Conexión con la base de datos
            var connectionString = "Host = 172.17.11.154;Username=postgres;Password=postgres;DataBase=DATOS_PRUEBA";
            await using var dataSource = NpgsqlDataSource.Create(connectionString);

            NpgsqlConnection connection = dataSource.OpenConnection();

            //Creación del comando
            NpgsqlCommand command = connection.CreateCommand();

            command.CommandText = $"SELECT ST_AsGeoJSON(dn_geom) FROM public.\"t$recinto\" WHERE provincia = {provincia} AND municipio = {municipio} AND agregado = " +
            $"{agregado} AND zona = {zona} AND poligono = {poligono} AND parcela = {parcela} AND recinto = {recinto}";


            NpgsqlDataReader reader = command.ExecuteReader();

            if (reader.Read())
            {
                // Serialización del objeto GeoJSON
                var geoJsonString = JsonConvert.SerializeObject(reader.GetString(0));

                string deserializedString = JsonConvert.DeserializeObject<string>(geoJsonString);
                geoJson geoJson = JsonConvert.DeserializeObject<geoJson>(deserializedString);
                return geoJson;
            }

            return null;
        }
    }

//    "{"type":"Polygon","crs":{"type":"name","properties":{"name":"EPSG:4258"}},
//        "coordinates":[[[-3.830208319,40.828641204],[-3.83021958,40.829897121],
//[-3.830225941,40.830600079],[-3.829723803,40.830639481],
//[-3.829667708,40.830622989],[-3.82965103,40.83063069],
//[-3.829615387,40.830661782],[-3.829596037,40.830700298],
//[-3.829579142,40.830715064],[-3.829566393,40.830877909],
//[-3.829672728,40.831263643],[-3.829466431,40.831375833],
//[-3.829290533,40.83145773],[-3.829132496,40.83155293],
//[-3.828936607,40.831760216],[-3.828907013,40.831868533],
//[-3.828907468,40.831869283],[-3.828805002,40.83193622],[-3.828803722,40.831935038],
//[-3.828769623,40.831950788],[-3.828699398,40.831978091],[-3.828634143,40.832026796],
//[-3.828564186,40.832075535],[-3.828465804,40.832108399],[-3.828402301,40.832108854],
//[-3.828329192,40.832093299],[-3.828271945,40.832029394],[-3.82820072,40.831976309],
//[-3.828158319,40.831971253],[-3.828102205,40.831998454],[-3.827945357,40.832058534],
//[-3.827670515,40.832276678],[-3.827677903,40.832303423],[-3.827678323,40.832337364],
//[-3.82769277,40.832364059],[-3.827707147,40.832385394],[-3.827864131,40.832433538],
//[-3.827870035,40.832465646],[-3.82790023,40.832506571],[-3.827906582,40.832523121],
//[-3.827616244,40.832712786],[-3.82712772,40.833031918],
//[-3.827088346,40.833013035],[-3.826922977,40.833141029],[-3.826465178,40.833318996],
//[-3.826236569,40.833371776],[-3.826085101,40.83339487],[-3.825673222,40.833451082],
//[-3.824800755,40.833581288],[-3.824388626,40.833634531],[-3.82378543,40.833722839],[-3.823394067,40.833773443],[-3.822855906,40.833855263],[-3.822636925,40.833888135],[-3.822586486,40.833798975],[-3.822658461,40.83366804],[-3.822760318,40.833639366],[-3.822956203,40.833610023],[-3.823098928,40.833537541],[-3.823192925,40.833500226],[-3.82323166,40.833440576],[-3.823261323,40.833378009],[-3.823289617,40.833269375],[-3.823290705,40.833158637],[-3.82334093,40.833039361],[-3.823361905,40.832915147],[-3.823360123,40.832839957],[-3.823347577,40.83276536],[-3.8233244,40.832692251],[-3.82329086,40.832621486],[-3.823368612,40.832581411],[-3.823330827,40.832520971],[-3.823325799,40.832508661],[-3.823325616,40.832493849],
//[-3.823376963,40.832434931],[-3.823311744,40.832430083],[-3.823255238,40.832404883],
//[-3.823229987,40.832381793],[-3.823213401,40.832354555],[-3.823207734,40.832304967],[-3.823217896,40.832275962],[-3.823237547,40.832249912],[-3.823265335,40.832228581],[-3.823299423,40.832213394],[-3.823282803,40.832142084],[-3.823248345,40.832074561],[-3.823197348,40.832013361],[-3.823131752,40.831960816],[-3.823074433,40.831928279],[-3.82298949,40.831895373],[-3.822805255,40.831704013],[-3.822856916,40.831694815],[-3.823049449,40.831659935],[-3.823222212,40.831628165],[-3.823372724,40.831599975],[-3.823501229,40.831575636],[-3.823617536,40.831553186],[-3.823734074,40.831530198],[-3.823859124,40.831505162],[-3.82398583,40.831479664],[-3.824103662,40.831455942],[-3.824205175,40.831436028],[-3.824296531,40.831419615],[-3.824387212,40.831406176],[-3.824484204,40.831394762],[-3.824584279,40.831383237],[-3.824681717,40.831369478],
//[-3.824771634,40.83135181],[-3.824853335,40.831331497],[-3.824926963,40.831310522],
//[-3.824992776,40.831290598],[-3.825050537,40.831271628],[-3.825100476,40.831253163],[-3.825143297,40.831234571],[-3.825182902,40.831214829],[-3.82522438,40.831192642],[-3.825271975,40.831166898],[-3.825328182,40.831137398],[-3.82539549,40.831104126],[-3.825473907,40.831067712],[-3.825556233,40.831030914],[-3.825632904,40.830997125],[-3.825697191,40.830968919],[-3.82575097,40.830944572],[-3.825798957,40.830921797],[-3.825844685,40.830898498],[-3.825888038,40.830875036],[-3.825928078,40.830852139],[-3.825964688,40.830829986],[-3.82600258,40.830806113],[-3.826047176,40.830777598],[-3.826102002,40.830742077],[-3.826163406,40.830700919],[-3.826225353,40.830656244],[-3.826283132,40.830610158],[-3.826335108,40.830564835],[-3.826380716,40.830522349],[-3.826419502,40.830484506],[-3.826452052,40.830450671],[-3.826479183,40.830419758],[-3.826501713,40.83039077],[-3.82651986,40.830362179],[-3.826533723,40.830332532],[-3.826543764,40.830300661],[-3.826551415,40.830267364],[-3.826558471,40.830233893],[-3.82656625,40.830201317],[-3.826576051,40.830169267],[-3.82658846,40.830137018],[-3.826604536,40.830103662],[-3.826625907,40.830067296],[-3.826654087,40.830025385],[-3.826690012,40.829976842],[-3.826731119,40.82992538],[-3.826774146,40.829875706],[-3.8267896,40.82985956],[-3.826816058,40.829831715],[-3.826855559,40.829794232],[-3.826891582,40.829763075],[-3.826924589,40.829737435],[-3.826961409,40.829713209],
//[-3.82700993,40.829685746],[-3.827075685,40.829651763],[-3.827153836,40.829613188],[-3.827236598,40.829573498],[-3.827317963,40.82953544],[-3.8273984,40.829499554],[-3.82748005,40.829465908],[-3.827564573,40.829434313],[-3.827651127,40.829403965],[-3.827738518,40.82937415],[-3.827826618,40.829344151],[-3.827919697,40.829314026],[-3.828023214,40.82928392],[-3.828140135,40.829254164],[-3.828263357,40.829225533],[-3.828383279,40.829198638],[-3.82849303,40.829174068],[-3.828596983,40.82915053],[-3.828702357,40.829126266],[-3.828814106,40.82910015],[-3.828927378,40.829072671],[-3.829035429,40.82904487],[-3.829132221,40.82901769],[-3.829217163,40.828991315],[-3.829291087,40.828965925],[-3.829355292,40.828940961],[-3.829414484,40.82891333],[-3.829474067,40.82887912],[-3.829539338,40.82883505],[-3.829614795,40.828780367],[-3.829704939,40.828714679],[-3.829717152,40.828706179],[-3.829727964,40.828719824],[-3.829783122,40.828757866],[-3.829826157,40.828774789],[-3.82987283,40.828784714],[-3.829921177,40.828787242],[-3.829969195,40.828782256],[-3.830025638,40.8287567],[-3.830076561,40.828725137],[-3.830120847,40.828688265],[-3.830157547,40.828646858],[-3.830208319,40.828641204]]]}"
}
